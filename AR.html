<!DOCTYPE html> 
<html lang="th">
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>AR สำหรับสถานที่</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- A-Frame -->
    <script src='https://aframe.io/releases/1.2.0/aframe.min.js'></script>
    <!-- AR.js for A-Frame (GPS-based AR) -->
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar-threex-location-only.js"></script>
    <!-- A-Frame Extras for Loaders -->
    <script src="https://raw.githack.com/donmccurdy/aframe-extras/master/dist/aframe-extras.loaders.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; }
        #back-button {
            position: absolute;
            top: 10px;
            left: 10px;
            padding: 10px 20px;
            background-color: rgba(255, 255, 255, 0.7);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            z-index: 2;
        }
    </style>
</head>
<body>
    <button id="back-button" onclick="goBack()">กลับ</button>
    <a-scene vr-mode-ui="enabled: false" arjs="sourceType: webcam; debugUIEnabled: false">
        <a-camera gps-camera rotation-reader></a-camera>
    <script>
        // ฟังก์ชันในการอ่านพารามิเตอร์จาก URL
        function getQueryParams() {
            const params = {};
            window.location.search.substring(1).split("&").forEach(pair => {
                const [key, value] = pair.split("=");
                params[decodeURIComponent(key)] = decodeURIComponent(value || '');
            });
            return params;
        }

        // ฟังก์ชันสำหรับปุ่มกลับ
        function goBack() {
            window.history.back();
        }

        // ฟังก์ชันในการโหลดข้อมูลสถานที่แบบ static หรือ dynamic
        function loadPlaces(placeId, placeName, coordinates) {
            // แผนที่ `id` ไปยัง URL ของโมเดล
            const modelMap = {
                1: {
                    modelUrl: 'image/bank.glb', // เปลี่ยนเป็น URL ของโมเดล
                    scale: '0.5 0.5 0.5',
                    rotation: '0 180 0'
                },
                2: {
                    modelUrl: 'image/park.glb', // เปลี่ยนเป็น URL ของโมเดล
                    scale: '0.5 0.5 0.5',
                    rotation: '0 180 0'
                },
                // เพิ่มสถานที่อื่น ๆ ตาม `id` ที่กำหนดใน `places` ของ `index.html`
                // ตัวอย่าง:
                // 3: { modelUrl: 'https://yourserver.com/models/model3.glb', scale: '0.7 0.7 0.7', rotation: '0 180 0' },
                // 4: { modelUrl: 'https://yourserver.com/models/model4.glb', scale: '0.6 0.6 0.6', rotation: '0 180 0' },
            };

            // ตรวจสอบว่ามีโมเดลสำหรับ `id` ที่เลือกหรือไม่
            if(modelMap[placeId]) {
                return [{
                    id: placeId,
                    name: placeName,
                    location: {
                        lat: coordinates.lat,
                        lng: coordinates.lng,
                    },
                    modelUrl: modelMap[placeId].modelUrl,
                    scale: modelMap[placeId].scale,
                    rotation: modelMap[placeId].rotation
                }];
            } else if(placeId !== undefined && placeId !== null) { // กรณีมี `id` แต่ไม่มีโมเดล
                return [{
                    id: placeId,
                    name: placeName,
                    location: {
                        lat: coordinates.lat,
                        lng: coordinates.lng,
                    },
                    modelUrl: null
                }];
            } else { // กรณีไม่มี `id` หรือพารามิเตอร์
                return [{
                    id: null,
                    name: 'สถานที่ไม่ระบุ',
                    location: {
                        lat: coordinates.lat,
                        lng: coordinates.lng,
                    },
                    modelUrl: null
                }];
            }
        }

        // ฟังก์ชันในการแสดงโมเดล AR
        function renderPlaces(places) {
            let scene = document.querySelector('a-scene');

            places.forEach((place) => {
                let latitude = place.location.lat;
                let longitude = place.location.lng;

                if(place.modelUrl) {
                    let model = document.createElement('a-entity');
                    model.setAttribute('gps-entity-place', `latitude: ${latitude}; longitude: ${longitude};`);
                    model.setAttribute('gltf-model', place.modelUrl);
                    model.setAttribute('rotation', place.rotation || '0 0 0');
                    model.setAttribute('animation-mixer', '');
                    model.setAttribute('scale', place.scale || '1 1 1');

                    model.addEventListener('loaded', () => {
                        window.dispatchEvent(new CustomEvent('gps-entity-place-loaded'))
                    });

                    scene.appendChild(model);
                } else {
                    // แสดงข้อความแทนโมเดล
                    let text = document.createElement('a-text');
                    text.setAttribute('gps-entity-place', `latitude: ${latitude}; longitude: ${longitude};`);
                    text.setAttribute('value', `ยินดีต้อนรับสู่ ${place.name}`);
                    text.setAttribute('scale', '10 10 10');
                    text.setAttribute('color', '#00FF00');
                    text.setAttribute('align', 'center');
                    scene.appendChild(text);
                }
            });
        }

        // เมื่อโหลดหน้า
        window.onload = () => {
            const params = getQueryParams();
            const placeId = parseInt(params.id) || null;
            const placeName = params.name || 'สถานที่';
            const lng = parseFloat(params.lng) || 100.19424882682976;
            const lat = parseFloat(params.lat) || 16.74518953316748;

            const places = loadPlaces(placeId, placeName, { lng, lat });
            renderPlaces(places);
        };
    </script>
</body>
</html>
