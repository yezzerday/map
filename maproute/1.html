<!DOCTYPE html>
<html>
  <head>
    <title>อาคารปราบไตรจักร</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1, width=device-width" />
    <style>
      /* กำหนดความสูงของแผนที่ให้เต็มหน้าจอ */
      #map {
        height: 100vh;
        width: 100%;
      }
    </style>
    <!-- โหลด Mapbox JavaScript และ CSS -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
    
    <script>
      mapboxgl.accessToken = 'pk.eyJ1IjoiamFydWRhIiwiYSI6ImNtMDc5ZXViMDEzNGkya3NicGZzaGI1ZncifQ.N2tDCng_RYc0uCAymQ-LdA';
      
      function initMap() {
        const destination = [100.19372806238205, 16.74810722965741];
        const map = new mapboxgl.Map({
          container: 'map',
          style: 'mapbox://styles/mapbox/streets-v11',
          center: destination,
          zoom: 14
        });

        new mapboxgl.Marker()
          .setLngLat(destination)
          .setPopup(new mapboxgl.Popup().setText("ปลายทาง"))
          .addTo(map);

        if (navigator.geolocation) {
          navigator.geolocation.watchPosition(
            (position) => {
              const userLocation = [position.coords.longitude, position.coords.latitude];

              // ลบเครื่องหมายผู้ใช้เดิมถ้ามี
              if (window.userMarker) window.userMarker.remove();

              // สร้างเครื่องหมายใหม่สำหรับตำแหน่งผู้ใช้
              window.userMarker = new mapboxgl.Marker({ color: 'blue' })
                .setLngLat(userLocation)
                .setPopup(new mapboxgl.Popup().setText("ตำแหน่งของคุณ"))
                .addTo(map);

              const bounds = new mapboxgl.LngLatBounds();
              bounds.extend(userLocation);
              bounds.extend(destination);
              map.fitBounds(bounds);

              getRoute(userLocation, destination, map);
            },
            () => {
              handleLocationError(true, map);
            },
            {
              enableHighAccuracy: true,
              timeout: 10000,
              maximumAge: 0
            }
          );
        } else {
          handleLocationError(false, map);
        }
      }

      // ฟังก์ชันขอเส้นทางจาก Mapbox Directions API
      async function getRoute(userLocation, destination, map) {
        const query = await fetch(
          `https://api.mapbox.com/directions/v5/mapbox/driving/${userLocation.join(',')};${destination.join(',')}?steps=true&geometries=geojson&access_token=${mapboxgl.accessToken}`,
          { method: 'GET' }
        );
        const data = await query.json();
        const route = data.routes[0].geometry;

        // ลบเส้นทางเดิม (ถ้ามี)
        if (map.getSource('route')) {
          map.getSource('route').setData({
            type: 'Feature',
            properties: {},
            geometry: route
          });
        } else {
          // เพิ่มเส้นทางใหม่ลงบนแผนที่
          map.addSource('route', {
            type: 'geojson',
            data: {
              type: 'Feature',
              properties: {},
              geometry: route
            }
          });

          map.addLayer({
            id: 'route',
            type: 'line',
            source: 'route',
            layout: { 'line-join': 'round', 'line-cap': 'round' },
            paint: { 'line-color': '#3887be', 'line-width': 5 }
          });
        }
      }

      function handleLocationError(browserHasGeolocation, map) {
        alert(
          browserHasGeolocation
            ? "บริการ Geolocation ล้มเหลว กรุณาเปิดใช้งาน Geolocation ในเบราว์เซอร์ของคุณ."
            : "เบราว์เซอร์ ของคุณ ไม่รองรับ Geolocation."
        );
      }
    </script>
  </head>
  <body onload="initMap()">
    <div id="map"></div>
  </body>
</html>

