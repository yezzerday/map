<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8" />
    <title>แผนที่นำทาง</title>
    <meta name="viewport" content="initial-scale=1, width=device-width" />
    <style>
        /* กำหนดความสูงของแผนที่ให้เต็มหน้าจอ */
        #map {
            height: 100vh;
            width: 100%;
        }
    </style>
    <!-- โหลด Mapbox GL JS -->
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.14.0/mapbox-gl.css' rel='stylesheet' />
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.14.0/mapbox-gl.js'></script>
    <script>
        // ข้อมูลปลายทาง
        const places = [
            {id: 1, name: 'อาคารปราบไตรจักร 1', coordinates: [100.19363102636527, 16.748053933408794], image: 'https://static.wixstatic.com/media/6725c1_e147c0a362854946b1f80e4f0de0f54a~mv2.jpg' },
            {id: 2, name: 'อาคารสำนักงานอธิการบดี', coordinates: [100.19210461849126,16.748191764771526 ], image: 'https://static.wixstatic.com/media/6725c1_2652e65a00b54cf89f3dc8ff06ba166a~mv2.jpg' },
            // ... (ข้อมูลปลายทางอื่นๆ)
        ];

        // ตั้งค่า access token ของ Mapbox
        mapboxgl.accessToken = 'pk.eyJ1IjoiamFydWRhIiwiYSI6ImNtMDc5ZXViMDEzNGkya3NicGZzaGI1ZncifQ.N2tDCng_RYc0uCAymQ-LdA';

        function initMap() {
            const urlParams = new URLSearchParams(window.location.search);
            const id = parseInt(urlParams.get('id'));

            const destinationPlace = places.find(place => place.id === id);

            if (!destinationPlace) {
                alert('ไม่พบปลายทางที่คุณเลือก');
                return; // อยู่ในฟังก์ชัน
            }

            const destination = [destinationPlace.coordinates[0], destinationPlace.coordinates[1]];

            const map = new mapboxgl.Map({
                container: 'map', 
                style: 'mapbox://styles/mapbox/streets-v12',
                center: destination,
                zoom: 14
            });

            const destinationMarker = new mapboxgl.Marker()
                .setLngLat(destination)
                .setPopup(new mapboxgl.Popup().setHTML(`<h4>${destinationPlace.name}</h4><img src="${destinationPlace.image}" alt="${destinationPlace.name}" width="150">`))
                .addTo(map);

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const userLocation = [position.coords.longitude, position.coords.latitude];

                        const userMarker = new mapboxgl.Marker({ color: 'blue' })
                            .setLngLat(userLocation)
                            .setPopup(new mapboxgl.Popup().setText('ตำแหน่งของคุณ'))
                            .addTo(map);

                        const bounds = new mapboxgl.LngLatBounds();
                        bounds.extend(userLocation);
                        bounds.extend(destination);
                        map.fitBounds(bounds, { padding: 20 });

                        createRoute(userLocation, destination, map);
                    },
                    () => {
                        handleLocationError(true, map.getCenter(), map);
                    }
                );
            } else {
                handleLocationError(false, map.getCenter(), map);
            }
        }

        function createRoute(start, end, map) {
            const url = `https://api.mapbox.com/directions/v5/mapbox/driving/${start[0]},${start[1]};${end[0]},${end[1]}?geometries=geojson&access_token=${mapboxgl.accessToken}`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    const route = data.routes[0].geometry.coordinates;
                    const geojson = {
                        type: 'FeatureCollection',
                        features: [{
                            type: 'Feature',
                            geometry: {
                                type: 'LineString',
                                coordinates: route
                            }
                        }]
                    };

                    map.addLayer({
                        id: 'route',
                        type: 'line',
                        source: {
                            type: 'geojson',
                            data: geojson
                        },
                        layout: {
                            'line-join': 'round',
                            'line-cap': 'round'
                        },
                        paint: {
                            'line-color': '#888',
                            'line-width': 8
                        }
                    });

                    route.forEach((point) => {
                        new mapboxgl.Marker()
                            .setLngLat(point)
                            .addTo(map);
                    });
                })
                .catch(err => console.error('Error fetching directions:', err));
        }

        function handleLocationError(browserHasGeolocation, pos, map) {
            alert(browserHasGeolocation ?
                'เกิดข้อผิดพลาดในการเข้าถึงตำแหน่งของคุณ.' :
                'เบราว์เซอร์ของคุณไม่รองรับ Geolocation.'
            );
            map.setCenter(pos);
        }

        window.onload = initMap; // เรียกใช้ฟังก์ชันเมื่อโหลดหน้า
    </script>
</head>
<body>
    <div id="map"></div>
</body>
</html>

